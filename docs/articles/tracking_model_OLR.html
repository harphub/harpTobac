<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Track OLR features • harpTobac</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Track OLR features">
<meta property="og:description" content="harpTobac">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">harpTobac</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tracking_model_OLR.html">Track OLR features</a>
    </li>
    <li>
      <a href="../articles/tracking_seviri_brightness_temp.html">Track satellite brightness temperature</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/harphub/harpTobac/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Track OLR features</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/harphub/harpTobac/blob/HEAD/vignettes/tracking_model_OLR.Rmd" class="external-link"><code>vignettes/tracking_model_OLR.Rmd</code></a></small>
      <div class="hidden name"><code>tracking_model_OLR.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this article, we show an example of tracking features in an
outgoing longwave radiation field from the NWP model MEPS. We are going
to make use of the <em>harpIO</em> package to load the data and the
<em>ggplot2</em> package, together with some expansions from the
<em>harpVis</em> package to plot the data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/harphub/harpIO" class="external-link">harpIO</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/harphub/harpVis" class="external-link">harpVis</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/harphub/harpTobac" class="external-link">harpTobac</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="loading-the-data">Loading the data<a class="anchor" aria-label="anchor" href="#loading-the-data"></a>
</h2>
<p>First we need to load the data using <code><a href="https://rdrr.io/pkg/harpIO/man/read_forecast.html" class="external-link">read_forecast()</a></code>
from the <em>harpIO</em> package. The data are downloaded from the open
data Thredds server at the Norwegian Meteorological Institute.</p>
<p>There are a few steps we need to go through to ensure we read the
data properly. First we’ll add the outgoing longwave parameter to the
parameter definitions so that <code><a href="https://rdrr.io/pkg/harpIO/man/read_forecast.html" class="external-link">read_forecast()</a></code> knows what
parameter to extract. The data are also negative for outgoing radiation
so we multiply by -1</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/harpIO/man/parameter_definitions.html" class="external-link">add_param_def</a></span><span class="op">(</span></span>
<span>  <span class="st">"olr"</span>, </span>
<span>  netcdf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/harpIO/man/file_parameter_definitions.html" class="external-link">new_netcdf_param</a></span><span class="op">(</span><span class="st">"toa_outgoing_longwave_flux"</span><span class="op">)</span>, </span>
<span>  func <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">*</span> <span class="op">-</span><span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Then we set the path and template for the file(s) to read, as well as
some information about the netcdf files.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">url</span>       <span class="op">&lt;-</span> <span class="st">"https://thredds.met.no/thredds/dodsC/meps25epsarchive"</span></span>
<span><span class="va">template</span>  <span class="op">&lt;-</span> <span class="st">"{YYYY}/{MM}/{DD}/{fcst_model}_sfc_{YYYY}{MM}{DD}T{HH}Z.ncml"</span></span>
<span><span class="va">file_opts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/harpIO/man/netcdf_opts.html" class="external-link">netcdf_opts</a></span><span class="op">(</span></span>
<span>  z_var <span class="op">=</span> <span class="st">"top_of_atmosphere"</span>, ref_time_var <span class="op">=</span> <span class="st">"forecast_reference_time"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>And now we can read the data…</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">olr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/harpIO/man/read_forecast.html" class="external-link">read_forecast</a></span><span class="op">(</span></span>
<span>  dttm             <span class="op">=</span> <span class="fl">2024052700</span>,</span>
<span>  fcst_model       <span class="op">=</span> <span class="st">"meps_det"</span>,</span>
<span>  parameter        <span class="op">=</span> <span class="st">"olr"</span>,</span>
<span>  lead_time        <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">23</span><span class="op">)</span>,</span>
<span>  file_path        <span class="op">=</span> <span class="va">url</span>, </span>
<span>  file_template    <span class="op">=</span> <span class="va">template</span>, </span>
<span>  file_format      <span class="op">=</span> <span class="st">"netcdf"</span>,</span>
<span>  file_format_opts <span class="op">=</span> <span class="va">file_opts</span>,</span>
<span>  param_defs       <span class="op">=</span> <span class="va">my_params</span>, </span>
<span>  return_data      <span class="op">=</span> <span class="cn">TRUE</span> </span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Reading https://thredds.met.no/thredds/dodsC/meps25epsarchive/2024/05/27/meps_det_sfc_20240527T00Z.ncml</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="feature-detction">Feature detction<a class="anchor" aria-label="anchor" href="#feature-detction"></a>
</h2>
<p>Feature detection is done using thresholds to identify contiguous
features in the field of interest at each time. This requires careful
selection of thresholds, so as a first step we will plot the OLR at each
time step.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">countries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/harpVis/man/get_map.html" class="external-link">get_map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/harpCore/man/get_domain.html" class="external-link">get_domain</a></span><span class="op">(</span><span class="va">olr</span><span class="op">$</span><span class="va">fcst</span><span class="op">)</span>, polygon <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/harpVis/man/geom_georaster.html" class="external-link">geom_georaster</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>geofield <span class="op">=</span> <span class="va">fcst</span><span class="op">)</span>, <span class="va">olr</span>, </span>
<span>    upscale_factor <span class="op">=</span> <span class="fl">8</span>, upscale_method <span class="op">=</span> <span class="st">"downsample"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_path</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>, <span class="va">countries</span>, colour <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">valid_dttm</span>, <span class="st">"%H:%M"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="va">OLR</span><span class="op">~</span><span class="st">"["</span><span class="op">*</span><span class="va">W.m</span><span class="op">^</span><span class="op">{</span><span class="op">-</span><span class="fl">2</span><span class="op">}</span><span class="op">*</span><span class="st">"]"</span><span class="op">)</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_equal</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_harp_map</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="tracking_model_OLR_files/figure-html/olr-plot-1.png" width="768" style="display: block; margin: auto;"></p>
<p>It looks like most of the interesting features are for OLR &lt; ~180.
We can get a better idea by masking all values that are &gt; 180, by
adding limits to the colour scale.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">countries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/harpVis/man/get_map.html" class="external-link">get_map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/harpCore/man/get_domain.html" class="external-link">get_domain</a></span><span class="op">(</span><span class="va">olr</span><span class="op">$</span><span class="va">fcst</span><span class="op">)</span>, polygon <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/harpVis/man/geom_georaster.html" class="external-link">geom_georaster</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>geofield <span class="op">=</span> <span class="va">fcst</span><span class="op">)</span>, <span class="va">olr</span>, </span>
<span>    upscale_factor <span class="op">=</span> <span class="fl">8</span>, upscale_method <span class="op">=</span> <span class="st">"downsample"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_path</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>, <span class="va">countries</span>, colour <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="va">valid_dttm</span>, <span class="st">"%H:%M"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="va">OLR</span><span class="op">~</span><span class="st">"["</span><span class="op">*</span><span class="va">W.m</span><span class="op">^</span><span class="op">{</span><span class="op">-</span><span class="fl">2</span><span class="op">}</span><span class="op">*</span><span class="st">"]"</span><span class="op">)</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, </span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">180</span><span class="op">)</span>, na.value <span class="op">=</span> <span class="st">"white"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_equal</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_harp_map</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="tracking_model_OLR_files/figure-html/olr-mask-plot-1.png" width="768" style="display: block; margin: auto;"></p>
<p>Using this information we will use thresholds of 180, 160 and 140 in
the feature detection, setting the target to “min” since we want
features to be identified that are less than the thresholds. Features
are detected using <code><a href="../reference/detect_features_multithreshold.html">detect_features_multithreshold()</a></code> that is
a wrapper around <a href="https://tobac.readthedocs.io/en/latest/tobac.html#module-tobac.feature_detection" class="external-link">tobac.feature_detection.feature_detection_multithreshold</a>
from the original Python package. We will only detect features that are
at least 16 contiguous pixels in size, and use the “weighted_diff”
method to set the position of the features.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">features</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/detect_features_multithreshold.html">detect_features_multithreshold</a></span><span class="op">(</span></span>
<span>  <span class="va">olr</span>, </span>
<span>  thresholds         <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">180</span>, <span class="fl">160</span>, <span class="fl">140</span><span class="op">)</span>,</span>
<span>  data_col           <span class="op">=</span> <span class="va">fcst</span>,</span>
<span>  target             <span class="op">=</span> <span class="st">"min"</span>,</span>
<span>  n_min_threshold    <span class="op">=</span> <span class="fl">16</span>, </span>
<span>  position_threshold <span class="op">=</span> <span class="st">"weighted_diff"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can now plot the feature locations for each threshold and
time.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">features</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">projection_x_coordinate</span>, <span class="va">projection_y_coordinate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_path</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>, <span class="va">countries</span>, colour <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">threshold_value</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/format.html" class="external-link">format</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="va">timestr</span>, tz <span class="op">=</span> <span class="st">"UTC"</span><span class="op">)</span>, <span class="st">"%H:%M"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_equal</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme_harp_map</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="fu">atop</span><span class="op">(</span><span class="va">OLR</span><span class="op">~</span><span class="va">Threshold</span>,<span class="st">"["</span><span class="op">*</span><span class="va">W.m</span><span class="op">^</span><span class="op">{</span><span class="op">-</span><span class="fl">2</span><span class="op">}</span><span class="op">*</span><span class="st">"]"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="tracking_model_OLR_files/figure-html/plot-features-1.png" width="768" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="segmentation">Segmentation<a class="anchor" aria-label="anchor" href="#segmentation"></a>
</h2>
<p>Having run the feature detection, the next step is to associate
regions with the identified features. This is done using
<code><a href="../reference/segment_2d.html">segment_2d()</a></code> that is a wrapper around the <a href="https://tobac.readthedocs.io/en/latest/tobac.html#module-tobac.segmentation" class="external-link">tobac.segmentation.segmentation_2D</a>
function from the original Python package. Here a single threshold is
needed, and we use the highest of the thresholds we used in the feature
detection. <code>segment_2d</code> returns a named list, but we can
destructure using the <code>%&lt;-%</code> operator from the
<em>zeallot</em> package.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/nteetor/zeallot" class="external-link">zeallot</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">segments</span>, <span class="va">features</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/zeallot/man/operator.html" class="external-link">%&lt;-%</a></span> <span class="fu"><a href="../reference/segment_2d.html">segment_2d</a></span><span class="op">(</span></span>
<span>  <span class="va">features</span>, </span>
<span>  <span class="va">olr</span>, </span>
<span>  threshold <span class="op">=</span> <span class="fl">180</span>, </span>
<span>  data_col  <span class="op">=</span> <span class="va">fcst</span>, </span>
<span>  target    <span class="op">=</span> <span class="st">"min"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><code>segments</code> is a data frame with a <em>geolist</em> coloumn
that contains fields with a mask identifying the areas that are
associated with each feature, while <code>features</code> is the same as
the output of the previous step, but with an extra column giving the
number of cells associated with each feature. The segment masks can be
overlayed on top of the original OLR data. Here we just show 4
times.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/harpVis/man/geom_georaster.html" class="external-link">geom_georaster</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>geofield <span class="op">=</span> <span class="va">fcst</span><span class="op">)</span>, <span class="va">olr</span><span class="op">[</span><span class="fl">11</span><span class="op">:</span><span class="fl">14</span>, <span class="op">]</span>, </span>
<span>    upscale_factor <span class="op">=</span> <span class="fl">4</span>, upscale_method <span class="op">=</span> <span class="st">"downsample"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/harpVis/man/geom_geocontour.html" class="external-link">geom_geocontour</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>geofield <span class="op">=</span> <span class="va">segmentation_mask</span><span class="op">)</span>, <span class="va">segments</span><span class="op">[</span><span class="fl">11</span><span class="op">:</span><span class="fl">14</span>, <span class="op">]</span>,</span>
<span>    colour <span class="op">=</span> <span class="st">"red"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_path</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>, <span class="va">countries</span>, colour <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">valid_dttm</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="fu">atop</span><span class="op">(</span><span class="va">OLR</span>,<span class="st">"["</span><span class="op">*</span><span class="va">W.m</span><span class="op">^</span><span class="op">{</span><span class="op">-</span><span class="fl">2</span><span class="op">}</span><span class="op">*</span><span class="st">"]"</span><span class="op">)</span><span class="op">)</span>, direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_equal</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">theme_harp_map</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="tracking_model_OLR_files/figure-html/plot-segment-mask-1.png" width="768" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="tracking">Tracking<a class="anchor" aria-label="anchor" href="#tracking"></a>
</h2>
<p>With the features identified, the tracking algorithm attempts to link
these features in time to produce tracks. The tracking is computed with
the <code><a href="../reference/link_tracks.html">link_tracks()</a></code> function that is a wrapper around <a href="https://tobac.readthedocs.io/en/latest/tobac.html#module-tobac.tracking" class="external-link">tobac.tracking.linking_trackpy</a>
from the original Python package.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tracks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/link_tracks.html">link_tracks</a></span><span class="op">(</span></span>
<span>  <span class="va">features</span>, </span>
<span>  <span class="va">olr</span>, </span>
<span>  data_col        <span class="op">=</span> <span class="va">fcst</span>, </span>
<span>  v_max           <span class="op">=</span> <span class="fl">20</span>, </span>
<span>  stubs           <span class="op">=</span> <span class="fl">2</span>,  </span>
<span>  subnetwork_size <span class="op">=</span> <span class="fl">100</span>, </span>
<span>  adaptive_step   <span class="op">=</span> <span class="fl">0.95</span>, </span>
<span>  adaptive_stop   <span class="op">=</span> <span class="fl">0.2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Some of the arguments in the call to <code><a href="../reference/link_tracks.html">link_tracks()</a></code>
require some experimentation, and are better explained in some of the <a href="https://tobac.readthedocs.io/en/latest/examples.html" class="external-link">tobac
examples</a>.</p>
<p>The tracks for each of the identified cells can easily be plotted.
For all tracks throughout the period this can be done making sure to
remove untracked cells (these are labelled -1).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">countries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/harpVis/man/get_map.html" class="external-link">get_map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/harpCore/man/get_domain.html" class="external-link">get_domain</a></span><span class="op">(</span><span class="va">olr</span><span class="op">$</span><span class="va">fcst</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tracks</span>, <span class="va">cell</span> <span class="op">&gt;</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_polygon.html" class="external-link">geom_polygon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>group <span class="op">=</span> <span class="va">group</span><span class="op">)</span>, <span class="va">countries</span>, fill <span class="op">=</span> <span class="st">"grey"</span>, colour <span class="op">=</span> <span class="st">"grey30"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_path</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">cell</span><span class="op">)</span>, colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">threshold_value</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html" class="external-link">arrow</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"open"</span>, angle <span class="op">=</span> <span class="fl">30</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="fu">atop</span><span class="op">(</span><span class="va">OLR</span><span class="op">~</span><span class="va">threshold</span>, <span class="st">"["</span><span class="op">*</span><span class="va">W.m</span><span class="op">^</span><span class="op">{</span><span class="op">-</span><span class="fl">2</span><span class="op">}</span><span class="op">*</span><span class="st">"]"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_equal</a></span><span class="op">(</span>expand <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu">theme_harp_map</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="tracking_model_OLR_files/figure-html/plot-tracks-1.png" width="768" style="display: block; margin: auto;"></p>
<p>We could then plot some statistics, such as the distribution of the
lifetimes of individual cells.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">tracks</span>, <span class="va">cell</span> <span class="op">&gt;</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>    lifetime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">time_cell</span><span class="op">)</span> <span class="op">/</span> <span class="fl">3600</span>, </span>
<span>    .by      <span class="op">=</span> <span class="va">cell</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">lifetime</span><span class="op">)</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"steelblue"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Cell lifetime [h]"</span><span class="op">)</span></span></code></pre></div>
<p><img src="tracking_model_OLR_files/figure-html/plot-cell-lifetime-1.png" width="576" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="epilogue">Epilogue<a class="anchor" aria-label="anchor" href="#epilogue"></a>
</h2>
<p>There are many analysis possibilities with these data. In addition
the <em>harpTobac</em> package gives you access to all of the
functionality of the Python tobac package via
<code>tobac$&lt;module name&gt;$&lt;function&gt;</code>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Andrew Singleton, Juan-Jesus Gonzalez.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
